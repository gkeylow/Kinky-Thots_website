# Security Audit Report — February 5, 2026

**Auditor:** Claude Code (automated)
**Scope:** Web server (home), Linode (reverse proxy, mail, landing page), mail server
**Trigger:** Post-compromise review following mail server incident (see `2026-02-04-mail-server-compromise.md`)

---

## Integrity Check Results

### Web Server (Home — kinky-web container)

| Check | Result | Severity |
|-------|--------|----------|
| Running processes | Clean — only Apache workers | OK |
| PHP webshells (eval/system/shell_exec/passthru) | None found | OK |
| Uploads directory for PHP files | None found | OK |
| `.env` file permissions | `-rw-------` (600) | OK |
| `.credentials.md` permissions | `-rw-------` (600) | OK |
| Apache config syntax | Valid | OK |
| Backend processes | Clean — only `node server.js` | OK |
| Docker containers | All expected, no rogue containers | OK |

### Linode Server (45.79.208.9 — reverse proxy, mail, RTMP)

| Check | Result | Severity |
|-------|--------|----------|
| Running processes | Clean — no miners/backdoors | OK |
| nginx config syntax | Valid | OK |
| nginx sites | 4 legitimate sites (kinky-thots, mail, status, photos) | OK |
| Proxy pass targets | All localhost — no external proxying | OK |
| Docker containers | 2 expected (mailserver, portainer_agent) | OK |
| Crontabs | No rogue crons | OK |
| SSH authorized keys | 5 keys, all "Generated By Termius" or GitHub | OK |
| Rootkit scanner | **Not installed** | LOW |
| Disk usage | 5.2G / 25G (23%) | OK |
| Recently modified /etc files | Only expected (nginx, iptables, locale) | OK |
| Mail queue | Empty | OK |
| Fail2ban | Active — 5 IPs banned on postfix, 1 on custom | OK |

### Mail Server (mailserver container)

| Check | Result | Severity |
|-------|--------|----------|
| Mail accounts | 3 accounts, all expected | OK |
| Aliases | 2 aliases, both to admin | OK |
| Open relay | `mynetworks` is empty — relay requires SASL auth | OK |
| DKIM keys | Present, 2048-bit RSA | OK |
| Rspamd | Active — 465 messages scanned, 3 spam caught | OK |
| Fail2ban | Active with tightened settings (3 retries/10min) | OK |
| Rate limiting | Active — 30 msg/min, 50 rcpt/msg, 100 conn/min | OK |

---

## Critical Findings

### CRITICAL: SSH Root Login with Password Enabled on Linode

**Risk:** Anyone on the internet can brute-force root access

**Evidence:**
```
PermitRootLogin yes
PasswordAuthentication yes
```

**Active brute force attacks RIGHT NOW (Feb 5):**
| IP | Failed Attempts Today |
|----|----------------------:|
| 16.16.80.196 | 430 |
| 68.183.12.182 | 209 |
| 52.176.138.195 | 141 |
| 152.42.130.251 | 139 |
| 52.176.138.178 | 137 |
| 20.169.72.169 | 132 |
| 146.190.23.251 | 103 |
| 213.209.159.159 | 94 |

**Fix:**
```bash
# /etc/ssh/sshd_config
PermitRootLogin prohibit-password   # Key-only root login
PasswordAuthentication no           # Disable all password auth
MaxAuthTries 3                      # Reduce max attempts
```
All 5 SSH keys are already in authorized_keys, so key-based access will continue to work.

### CRITICAL: No SSH Fail2Ban on Linode Host

**Risk:** 1,400+ SSH brute force attempts today alone with no blocking

The fail2ban inside the mail container only protects mail ports. The Linode host OS has no SSH brute force protection.

**Fix:** Install and configure fail2ban on the Linode host:
```bash
apt install fail2ban
# Configure /etc/fail2ban/jail.local for sshd
```

### HIGH: MariaDB Listening on 0.0.0.0:3306

**Risk:** Database port exposed to all network interfaces on home server

**Evidence:** `ss -tlnp` shows MariaDB bound to `0.0.0.0:3306`

**Additional risk:** The `gkeylow` and `root` DB users have `Host: %` (any host)

**Fix:** Bind MariaDB to localhost only, or remove the port mapping from docker-compose.yml since only the backend container needs access via Docker networking.

### HIGH: Immich Server Unhealthy

**Evidence:** `immich_server` container status is `(unhealthy)` — has been up 4 hours but reports unhealthy. This proxies through Linode as `photos.kinky-thots.xxx`.

**Fix:** Investigate Immich health check failures and ensure it's either healthy or stopped.

### MEDIUM: SPF Record Had Wrong IP

**Status: FIXED** — Updated from `ip4:45.33.100.131 ~all` to `ip4:45.79.208.9 -all`

The old SPF record referenced a decommissioned Linode IP and used soft fail (`~all`) instead of hard fail (`-all`).

### MEDIUM: DMARC Was Quarantine, Not Reject

**Status: FIXED** — Updated to:
```
v=DMARC1; p=reject; sp=reject; adkim=s; aspf=s; rua=mailto:admin@kinky-thots.com; pct=100
```

This now:
- Rejects (not quarantines) emails that fail DMARC
- Applies to subdomains too (`sp=reject`)
- Uses strict DKIM and SPF alignment (`adkim=s; aspf=s`)
- Applies to 100% of messages

### MEDIUM: Portainer Agent Exposed on 0.0.0.0:9001 (Both Servers)

**Risk:** Portainer Agent API is accessible from any network interface on both home server and Linode.

**Fix:** Bind to localhost or restrict via firewall to known management IPs only.

### LOW: World-Writable Files in /etc on Linode

**Evidence:** 20+ files in /etc are world-writable. Most are Ubuntu defaults but represent unnecessary permissions.

**Fix:** `chmod o-w` on sensitive files, especially `/etc/profile` and `/etc/.pwd.lock`

### LOW: No Rootkit Scanner on Linode

**Fix:** Install rkhunter or chkrootkit for periodic scans.

---

## Hardening Recommendations

### Immediate (Do This Week)

| # | Action | Server | Priority |
|---|--------|--------|----------|
| 1 | Disable SSH password auth, require key-only | Linode | CRITICAL |
| 2 | Install fail2ban for SSH on Linode host | Linode | CRITICAL |
| 3 | Remove MariaDB port 3306 from docker-compose `ports:` (use Docker network only) | Home | HIGH |
| 4 | Restrict DB user `gkeylow` host to `172.%` (Docker network only) | Home | HIGH |
| 5 | Restrict Portainer Agent to localhost or management IPs | Both | MEDIUM |
| 6 | Fix Immich health or stop the container | Home | MEDIUM |

### Short-Term (This Month)

| # | Action | Server | Priority |
|---|--------|--------|----------|
| 7 | Install rkhunter on Linode, run weekly scan | Linode | LOW |
| 8 | Set up Linode Cloud Firewall (whitelist only needed ports) | Linode | MEDIUM |
| 9 | Enable automatic security updates (`unattended-upgrades`) | Linode | MEDIUM |
| 10 | Add `X-Content-Security-Policy` / CSP headers to nginx | Linode | MEDIUM |
| 11 | Rotate all CDN API keys (noted as previously exposed in git) | Both | HIGH |
| 12 | Move Linode API token out of docs/.linode-api.md into env/secrets | Both | MEDIUM |
| 13 | Set up log-based alerting (mail volume spikes, SSH brute force) | Both | MEDIUM |

### Long-Term (Ongoing)

| # | Action | Priority |
|---|--------|----------|
| 14 | Migrate SSH to non-standard port (reduce noise) | LOW |
| 15 | Set up centralized logging (ship logs to monitoring) | MEDIUM |
| 16 | Implement 2FA for SSH access (e.g., Google Authenticator PAM) | LOW |
| 17 | Add TLSA/DANE records for mail server | LOW |
| 18 | Regular penetration testing (quarterly) | MEDIUM |

---

## Security Testing Schedule

### Daily (Automated)

| Task | How | What to Monitor |
|------|-----|-----------------|
| Mail queue check | `docker exec mailserver postqueue -p` | Should be empty or near-empty |
| Fail2ban status | `docker exec mailserver fail2ban-client status` | Check ban counts are reasonable |
| Container health | `docker ps` on both servers | All should show "healthy" or "running" |
| SSH login check | `last -5` on Linode | Watch for unexpected IPs |
| Disk usage | `df -h /` on both servers | Alert if >80% |

**Automation:** Add a cron job or use Uptime Kuma to run these checks daily and alert on anomalies.

Example daily cron (`/etc/cron.daily/security-check`):
```bash
#!/bin/bash
# Daily security check — runs at 6:25 AM via cron.daily

ALERT_EMAIL="admin@kinky-thots.com"
REPORT=""

# Check mail queue size
QUEUE=$(docker exec mailserver postqueue -p 2>/dev/null | tail -1)
if [[ "$QUEUE" != "Mail queue is empty" ]]; then
    REPORT+="WARNING: Mail queue not empty: $QUEUE\n"
fi

# Check for new fail2ban bans
BANS=$(docker exec mailserver fail2ban-client status postfix 2>/dev/null | grep "Total banned" | awk '{print $NF}')
if [[ "$BANS" -gt 20 ]]; then
    REPORT+="WARNING: High fail2ban ban count: $BANS\n"
fi

# Check container health
UNHEALTHY=$(docker ps --filter health=unhealthy --format '{{.Names}}' 2>/dev/null)
if [[ -n "$UNHEALTHY" ]]; then
    REPORT+="WARNING: Unhealthy containers: $UNHEALTHY\n"
fi

# Check disk usage
USAGE=$(df / --output=pcent | tail -1 | tr -d ' %')
if [[ "$USAGE" -gt 80 ]]; then
    REPORT+="WARNING: Disk usage at ${USAGE}%\n"
fi

# Send alert if any issues found
if [[ -n "$REPORT" ]]; then
    echo -e "Daily Security Report\n\n$REPORT" | mail -s "[ALERT] Security Check $(date +%F)" "$ALERT_EMAIL"
fi
```

### Weekly (Manual or Automated)

| Task | How | Purpose |
|------|-----|---------|
| Review mail server logs | Grep for unusual `sasl_username` activity | Catch compromised accounts early |
| Check SSH brute force volume | `grep 'Failed password' /var/log/auth.log \| wc -l` | Ensure fail2ban is keeping up |
| Blacklist check | Visit [multirbl.valli.org](https://multirbl.valli.org/lookup/45.79.208.9.html) | Ensure IP isn't blacklisted |
| Review fail2ban bans | `fail2ban-client status` on all jails | Track attack patterns |
| Check SSL certificate expiry | `certbot certificates` | Ensure auto-renewal is working |
| Review nginx access logs | Look for unusual request patterns, 4xx/5xx spikes | Catch web attacks |
| Package updates | `apt list --upgradable` on Linode | Stay on top of security patches |

Example weekly cron (`/etc/cron.weekly/security-review`):
```bash
#!/bin/bash
# Weekly security review

ALERT_EMAIL="admin@kinky-thots.com"
REPORT="Weekly Security Review — $(date +%F)\n\n"

# SSH failed login count this week
SSH_FAILS=$(grep 'Failed password' /var/log/auth.log | grep "$(date +%b)" | wc -l)
REPORT+="SSH failed logins this week: $SSH_FAILS\n"

# Top SSH attackers
REPORT+="Top SSH attackers:\n"
REPORT+="$(grep 'Failed password' /var/log/auth.log | grep -oP 'from \K[0-9.]+' | sort | uniq -c | sort -rn | head -5)\n\n"

# Fail2ban summary
REPORT+="Fail2ban postfix bans: $(docker exec mailserver fail2ban-client status postfix 2>/dev/null | grep 'Total banned' | awk '{print $NF}')\n"
REPORT+="Fail2ban dovecot bans: $(docker exec mailserver fail2ban-client status dovecot 2>/dev/null | grep 'Total banned' | awk '{print $NF}')\n\n"

# SSL cert expiry
REPORT+="SSL certificates:\n"
REPORT+="$(certbot certificates 2>/dev/null | grep -E 'Domains:|Expiry')\n\n"

# Mail outbound volume (last 7 days)
REPORT+="Mail sent last 7 days: $(grep 'status=sent' /opt/mailserver/mail-logs/mail.log | wc -l)\n"
REPORT+="Mail bounced last 7 days: $(grep 'status=bounced' /opt/mailserver/mail-logs/mail.log | wc -l)\n"

# Upgradable packages
UPGRADABLE=$(apt list --upgradable 2>/dev/null | grep -c upgradable)
REPORT+="Packages needing update: $UPGRADABLE\n"

echo -e "$REPORT" | mail -s "Weekly Security Review $(date +%F)" "$ALERT_EMAIL"
```

### Monthly (Manual Review)

| Task | Purpose |
|------|---------|
| Full log audit | Review all access logs, auth logs, mail logs for anomalies |
| Password rotation | Rotate mail passwords, DB passwords, API keys |
| Docker image updates | `docker pull` latest images, rebuild containers |
| Backup verification | Test restoring from backup to ensure data integrity |
| DNS record audit | Verify SPF, DKIM, DMARC, MX records are correct |
| Firewall rule review | Audit iptables rules on both servers |
| User account audit | Review DB users, mail accounts, SSH keys |
| Dependency audit | `npm audit` on backend, check for vulnerable packages |
| Penetration test | Run basic external scan (nmap, SSL Labs, etc.) |
| Certificate renewal check | Verify certbot auto-renewal is working |

### Quarterly

| Task | Purpose |
|------|---------|
| Full security review | Comprehensive audit of all systems (like this report) |
| Credential rotation | Rotate ALL credentials (API keys, tokens, passwords) |
| Infrastructure review | Evaluate if architecture changes are needed |
| Incident response drill | Review incident response plan, test recovery procedures |

---

## Current Security Posture Summary

| Area | Score | Notes |
|------|-------|-------|
| **Email Security** | 8/10 | DMARC reject, SPF hard fail, DKIM, rate limiting, fail2ban — strong after fixes |
| **SSH Security** | 3/10 | Password auth enabled, no host fail2ban, root login allowed — **needs urgent fix** |
| **Web Application** | 7/10 | No webshells, proper file perms, .htaccess protection, headers set |
| **Database** | 5/10 | Port exposed on 0.0.0.0, wildcard host users — **needs fix** |
| **Network** | 6/10 | SSH tunnel architecture is good, but exposed ports and no cloud firewall |
| **Monitoring** | 3/10 | No automated alerting, attack went unnoticed 34 hours — **needs setup** |
| **Credentials** | 5/10 | Some stored in docs, CDN keys need rotation, weak mail password was compromised |

**Overall: 5.3/10 — Significant improvements needed, especially SSH hardening and monitoring.**

---

## Actions Already Taken (Feb 5, 2026)

1. Changed compromised mail password
2. Blocked attacker IP (iptables + fail2ban 180-day ban)
3. Flushed spam from mail queue
4. Tightened fail2ban (3 retries / 10 min)
5. Added Postfix rate limiting (30 msg/min)
6. Updated DMARC to `p=reject` with strict alignment
7. Fixed SPF to correct IP with hard fail (`-all`)
8. Updated backend SMTP credentials
9. Documented incident in `docs/2026-02-04-mail-server-compromise.md`
